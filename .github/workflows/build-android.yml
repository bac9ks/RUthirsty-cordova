name: Build Android APK

on:
  # 当推送到 main 分支时触发
  push:
    branches: [ main ]

  # 当创建 Pull Request 到 main 分支时触发
  pull_request:
    branches: [ main ]

  # 允许手动触发（在 GitHub Actions 页面点击 "Run workflow"）
  workflow_dispatch:

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
    # 1. 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 设置 Node.js 环境
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    # 3. 设置 Java 环境（使用 Java 17）
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 4. 设置 Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 5. 安装项目依赖（如果有 package.json）
    - name: Install npm dependencies
      run: |
        if [ -f package.json ]; then
          npm install
        fi

    # 6. 安装 Cordova CLI
    - name: Install Cordova
      run: npm install -g cordova

    # 7. 添加 Android 平台（使用稳定版本 13.0.0）
    - name: Add Android platform
      run: cordova platform add android@13.0.0

    # 8. 构建调试 APK
    - name: Build debug APK
      run: cordova build android --debug
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}

    # 9. 上传 APK 作为构建产物
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: platforms/android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

    # 10. 显示 APK 信息
    - name: Display APK info
      run: |
        APK_PATH="platforms/android/app/build/outputs/apk/debug/app-debug.apk"
        if [ -f "$APK_PATH" ]; then
          echo "✅ APK 构建成功！"
          ls -lh "$APK_PATH"
          echo "APK 大小: $(du -h "$APK_PATH" | cut -f1)"
        else
          echo "❌ APK 文件未找到"
          exit 1
        fi
