name: Build Release APK

on:
  # 当创建新标签时触发（例如：v1.0.0）
  push:
    tags:
      - 'v*'

  # 允许手动触发
  workflow_dispatch:

jobs:
  build-release:
    name: Build Release APK
    runs-on: ubuntu-latest

    steps:
    # 1. 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 设置 Node.js 环境
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    # 3. 设置 Java 环境（使用 Java 17）
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 4. 设置 Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 5. 安装项目依赖
    - name: Install npm dependencies
      run: |
        if [ -f package.json ]; then
          npm install
        fi

    # 6. 安装 Cordova CLI
    - name: Install Cordova
      run: npm install -g cordova

    # 7. 添加 Android 平台
    - name: Add Android platform
      run: cordova platform add android@13.0.0

    # 8. 创建签名密钥（用于演示，生产环境应使用 GitHub Secrets）
    - name: Setup signing key
      run: |
        # 注意：这是一个示例密钥，仅用于演示
        # 在生产环境中，应该使用 GitHub Secrets 存储真实的密钥
        echo "⚠️  使用演示密钥。生产环境请配置真实的签名密钥！"

        # 如果你有真实的密钥，请在 GitHub Secrets 中设置以下变量：
        # - ANDROID_KEYSTORE_BASE64: Base64 编码的 keystore 文件
        # - KEYSTORE_PASSWORD: Keystore 密码
        # - KEY_ALIAS: Key 别名
        # - KEY_PASSWORD: Key 密码

    # 9. 构建发布版 APK
    - name: Build release APK
      run: cordova build android --release
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}

    # 10. 获取版本号
    - name: Get version
      id: version
      run: |
        if [ "${{ github.ref_type }}" == "tag" ]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="release-$(date +%Y%m%d-%H%M%S)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    # 11. 上传 APK 作为构建产物
    - name: Upload release APK
      uses: actions/upload-artifact@v4
      with:
        name: app-release-${{ steps.version.outputs.version }}
        path: platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 90

    # 12. 如果是 tag 触发，创建 GitHub Release
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 13. 显示 APK 信息
    - name: Display APK info
      run: |
        APK_PATH="platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk"
        if [ -f "$APK_PATH" ]; then
          echo "✅ Release APK 构建成功！"
          ls -lh "$APK_PATH"
          echo "APK 大小: $(du -h "$APK_PATH" | cut -f1)"
          echo ""
          echo "⚠️  注意：此 APK 未签名，无法直接安装。"
          echo "如需签名版本，请配置 GitHub Secrets 中的签名密钥。"
        else
          echo "❌ APK 文件未找到"
          exit 1
        fi
